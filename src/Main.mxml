<?xml version="1.0" encoding="utf-8"?>
<s:Application xmlns:fx="http://ns.adobe.com/mxml/2009" 
               xmlns:s="library://ns.adobe.com/flex/spark"
			   xmlns="*"
               width="675"
               height="645"
               backgroundColor="0x000000"
               frameRate="60"
               applicationComplete="init()">
	<fx:Script><![CDATA[
		import flash.desktop.*;
		import flash.display.*;
		import flash.events.*;
		import flash.geom.*;
		import flash.media.*;
		import flash.text.*;
		import flash.ui.*;
		import flash.utils.*;
		import flash.net.*;
		
		import mx.collections.ArrayCollection;
		import mx.controls.Alert;
		
		[Bindable]
		private var doc: Document = new Document();
		
		private var prevHash: String = null;
		
		/*
		public function Main() {
			init();
		}
		*/
		
		public function init(): void {
			/*
			stage.scaleMode = StageScaleMode.NO_SCALE;
			stage.align = StageAlign.TOP; // top-centered
			*/
			stage.focus = stage;
			stage.addEventListener(Event.ENTER_FRAME, onEnterFrame);
			stage.addEventListener(MouseEvent.MOUSE_DOWN, onMousePressed);
			stage.addEventListener(MouseEvent.MOUSE_UP, onMouseReleased);
			stage.addEventListener(KeyboardEvent.KEY_DOWN, onKeyPressed);
			stage.addEventListener(KeyboardEvent.KEY_UP, onKeyReleased);
			doc.history.watch(onUpdated);
			
			ExternalInterface.addCallback("hashUpdatedExternally", hashUpdatedExternally);
		}
		
		private function onEnterFrame(event: Event): void {
			Model.updateAll();
		}
		
		private function onMousePressed(event: MouseEvent): void {
		}
		
		private function onMouseReleased(event: MouseEvent): void {
		}
		
		private function onKeyPressed(event: KeyboardEvent): void {
			//trace(event.keyCode, String.fromCharCode(event.charCode));
		}
		
		private function onKeyReleased(event: KeyboardEvent): void {
		}
		
		private function onUpdated(): void {
			var hash: String = doc.toString();
			if (prevHash == null) {
				prevHash = hash;
			} else if (prevHash != hash) {
				prevHash = hash;
				//fragment.text = hash;
				trace("a");
				ExternalInterface.call("documentUpdated", hash);
				trace("b");
			}
		}
		/*
		private function onFragmentPaste(): void {
			fragment.text = Clipboard.generalClipboard.getData(ClipboardFormats.TEXT_FORMAT) as String;
			doc.history.record(new ChangeSong(doc, fragment.text));
		}
		*/
		private function hashUpdatedExternally(myhash: String): void {
				trace("c");
			if (prevHash != myhash) {
				prevHash = myhash;
				//fragment.text = myhash;
				doc.history.record(new ChangeSong(doc, prevHash));
			}
				trace("d");
		}
	]]></fx:Script>
	
	<s:VGroup width="100%">
		<!--
		<s:TextInput id="fragment" width="100%" editable="false" selectable="true" paste="onFragmentPaste(); fragment.selectAll()" focusIn="fragment.selectAll()"/>
		-->
		<SongEditor doc="{doc}"/>
	</s:VGroup>
</s:Application>
